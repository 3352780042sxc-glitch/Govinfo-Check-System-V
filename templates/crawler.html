{% extends 'base.html' %}

{% block content %}
    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md12">
                <h2 class="layui-text-center">数据抓取</h2>
                
                <!-- 抓取表单 -->
                <div class="layui-card">
                    <div class="layui-card-header">数据采集管理</div>
                    <div class="layui-card-body">
                        <form method="POST" action="" class="layui-form">
                            {{ form.hidden_tag() }}
                            <div class="layui-form-item">
                                <div class="layui-col-md4">
                                    <label class="layui-form-label">{{ form.keyword.label.text }}</label>
                                    <div class="layui-input-block">
                                        {{ form.keyword(class="layui-input") }}
                                    </div>
                                </div>
                                <div class="layui-col-md2">
                                    <label class="layui-form-label">{{ form.quantity.label.text }}</label>
                                    <div class="layui-input-block">
                                        {{ form.quantity(class="layui-input") }}
                                    </div>
                                </div>
                                <div class="layui-col-md2">
                                    <label class="layui-form-label">{{ form.pages.label.text }}</label>
                                    <div class="layui-input-block">
                                        {{ form.pages(class="layui-input") }}
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-input-block">
                                        {{ form.submit(class="layui-btn layui-btn-green") }}
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 进度显示 -->
                <div class="layui-card mt10" id="progress-card" style="display: none;">
                    <div class="layui-card-header">采集进度</div>
                    <div class="layui-card-body">
                        <div class="layui-progress layui-progress-big" lay-filter="progress-filter">
                            <div class="layui-progress-bar" lay-percent="0%"></div>
                        </div>
                        <p class="layui-text-center mt10" id="progress-text">正在采集数据...</p>
                    </div>
                </div>

                <!-- 抓取结果 -->
                {% if keyword and results %}
                    <div class="layui-card mt10">
                        <div class="layui-card-header">
                            <div class="layui-row">
                                <div class="layui-col-md8">
                                    搜索结果："{{ keyword }}" (共 {{ results|length }} 条)
                                </div>
                                <div class="layui-col-md4 text-right">
                                    <button class="layui-btn layui-btn-blue" id="save-selected">保存选中</button>
                                </div>
                            </div>
                        </div>
                        <div class="layui-card-body">
                            <div class="layui-row">
                                {% for news in results %}
                                    <div class="layui-col-md12 mb10">
                                        <div class="layui-card">
                                            <div class="layui-card-body">
                                                <div class="layui-row">
                                                    <div class="layui-col-md1">
                                                        <input type="checkbox" name="news-checkbox" lay-skin="primary" data-id="{{ loop.index0 }}">
                                                    </div>
                                                    <div class="layui-col-md11">
                                                        <h4>
                                                            <a href="{{ news.original_url }}" target="_blank" class="layui-text-blue">
                                                                {{ news.title }}
                                                            </a>
                                                        </h4>
                                                        <p class="layui-text-gray mt5 mb5">{{ news.source }}</p>
                                                        <p class="mb10">{{ news.summary }}</p>
                                                        {% if news.cover %}
                                                            <div class="layui-row">
                                                                <img src="{{ news.cover }}" alt="封面" class="layui-upload-img" style="max-width: 300px; max-height: 200px;">
                                                            </div>
                                                        {% endif %}
                                                        <div class="layui-row mt5">
                                                            <a href="{{ news.original_url }}" target="_blank" class="layui-btn layui-btn-sm layui-btn-primary">
                                                                查看原文
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // 初始化layui组件
        layui.use(['form'], function() {
            var form = layui.form;
            
            // 表单验证
            form.verify({
                keyword: function(value) {
                    if (value.length < 1) {
                        return '请输入搜索关键字';
                    }
                }
            });
        });
    </script>
{% endblock %}